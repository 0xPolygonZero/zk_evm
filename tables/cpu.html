<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CPU - The Polygon Zero zkEVM Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Polygon Zero zkEVM Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h2 id="cpu"><a class="header" href="#cpu">CPU</a></h2>
<p>The CPU is the central component of the zkEVM. Like any CPU, it reads
instructions, executes them and modifies the state (registers and the
memory) accordingly. The constraining of some complex instructions (e.g.
Keccak hashing) is delegated to other tables. This section will only
briefly present the CPU and its columns. Details about the CPU logic
will be provided later.</p>
<h3 id="cpu-flow"><a class="header" href="#cpu-flow">CPU flow</a></h3>
<p>An execution run can be decomposed into two distinct parts:</p>
<ul>
<li>
<p><strong>CPU cycles:</strong> The bulk of the execution. In each row, the CPU
reads the current code at the program counter (PC) address, and
executes it. The current code can be the kernel code, or whichever
code is being executed in the current context (transaction code or
contract code). Executing an instruction consists in modifying the
registers, possibly performing some memory operations, and updating
the PC.</p>
</li>
<li>
<p><strong>Padding:</strong> At the end of the execution, we need to pad the length
of the CPU trace to the next power of two. When the program counter
reaches the special halting label in the kernel, execution halts.
Constraints ensure that every subsequent row is a padding row and
that execution cannot resume.</p>
</li>
</ul>
<p>In the CPU cycles phase, the CPU can switch between different contexts,
which correspond to the different environments of the possible calls.
Context 0 is the kernel itself, which handles initialization (input
processing, transaction parsing, transaction trie updating...) and
termination (receipt creation, final trie checks...) before and after
executing the transaction. Subsequent contexts are created when
executing user code (transaction or contract code). In a non-zero user
context, syscalls may be executed, which are specific instructions
written in the kernel. They don't change the context but change the code
context, which is where the instructions are read from.</p>
<h4 id="continuations"><a class="header" href="#continuations">Continuations</a></h4>
<p>A full run of the zkEVM consists in initializing the zkEVM with the
input state, executing a certain number of transactions, and then
validating the output state. However, for performance reasons, a run is
split in multiple segments of at most <code>MAX_CPU_CYCLES</code> cycles, which can
be proven individually. Continuations ensure that the segments are part
of the same run and guarantees that the state at the end of a segment is
equal to the state at the beginning of the next.</p>
<p>The state to propagate from one segment to another contains some of the
zkEVM registers plus the current memory. These registers are stored in
memory as dedicated global metadata, and the memory to propagate is
stored in two STARK tables: <code>MemBefore</code> and <code>MemAfter</code>. To check the
consistency of the memory, the Merkle cap of the previous <code>MemAfter</code> is
compared to the Merkle cap of the next <code>MemBefore</code>.</p>
<h3 id="cpu-columns"><a class="header" href="#cpu-columns">CPU columns</a></h3>
<h4 id="registers"><a class="header" href="#registers">Registers</a></h4>
<ul>
<li>
<p><code>context</code>: Indicates which context we are in. 0 for the kernel, and
a positive integer for every user context. Incremented by 1 at every
call.</p>
</li>
<li>
<p><code>code_context</code>: Indicates in which context the code to execute
resides. It's equal to <code>context</code> in user mode, but is always 0 in
kernel mode.</p>
</li>
<li>
<p><code>program_counter</code>: The address of the instruction to be read and
executed.</p>
</li>
<li>
<p><code>stack_len</code>: The current length of the stack.</p>
</li>
<li>
<p><code>is_kernel_mode</code>: Boolean indicating whether we are in kernel (i.e.
privileged) mode. This means we are executing kernel code, and we
have access to privileged instructions.</p>
</li>
<li>
<p><code>gas</code>: The current amount of gas used in the current context. It is
eventually checked to be below the current gas limit. Must fit in 32
bits.</p>
</li>
<li>
<p><code>clock</code>: Monotonic counter which starts at 0 and is incremented by 1
at each row. Used to enforce correct ordering of memory accesses.</p>
</li>
<li>
<p><code>opcode_bits</code>: 8 boolean columns, which are the bit decomposition of
the opcode being read at the current PC.</p>
</li>
</ul>
<h4 id="operation-flags"><a class="header" href="#operation-flags">Operation flags</a></h4>
<p>Boolean flags. During CPU cycles phase, each row executes a single
instruction, which sets one and only one operation flag. No flag is set
during padding. The decoding constraints ensure that the flag set
corresponds to the opcode being read. There isn't a 1-to-1
correspondence between instructions and flags. For efficiency, the same
flag can be set by different, unrelated instructions (e.g. <code>eq_iszero</code>,
which represents the <code>EQ</code> and the <code>ISZERO</code> instructions). When there is
a need to differentiate them in constraints, we filter them with their
respective opcode: since the first bit of <code>EQ</code>'s opcode (resp.
<code>ISZERO</code>'s opcode) is 0 (resp. 1), we can filter a constraint for an EQ
instruction with <code>eq_iszero * (1 - opcode_bits[0])</code> (resp.
<code>eq_iszero * opcode_bits[0]</code>).</p>
<h4 id="memory-columns"><a class="header" href="#memory-columns">Memory columns</a></h4>
<p>The CPU interacts with the EVM memory via its memory channels. At each
row, a memory channel can execute a write, a read, or be disabled. A
full memory channel is composed of:</p>
<ul>
<li>
<p><code>used</code>: Boolean flag. If it's set to 1, a memory operation is
executed in this channel at this row. If it's set to 0, no operation
is done but its columns might be reused for other purposes.</p>
</li>
<li>
<p><code>is_read</code>: Boolean flag indicating if a memory operation is a read
or a write.</p>
</li>
<li>
<p>3 <code>address</code> columns. A memory address is made of three parts:
<code>context</code>, <code>segment</code> and <code>virtual</code>.</p>
</li>
<li>
<p>8 <code>value</code> columns. EVM words are 256 bits long, and they are broken
down in 8 32-bit limbs.</p>
</li>
</ul>
<p>The last memory channel is a partial channel: it doesn't have its own
<code>value</code> columns and shares them with the first full memory channel. This
allows us to save eight columns.</p>
<h4 id="general-columns"><a class="header" href="#general-columns">General columns</a></h4>
<p>There are 8 shared general columns. Depending on the instruction, they
are used differently:</p>
<ul>
<li>
<p><code>Exceptions</code>: When raising an exception, the first three general
columns are the bit decomposition of the exception code. They are
used to jump to the correct exception handler.</p>
</li>
<li>
<p><code>Logic</code>: For EQ, and ISZERO operations, it's easy to check that the
result is 1 if <code>input0</code> and <code>input1</code> are equal. It's more difficult
to prove that, if the result is 0, the inputs are actually unequal.
To prove it, each general column contains the modular inverse of
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0219em;vertical-align:-0.2719em;"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord texttt">input0</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0219em;vertical-align:-0.2719em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">input1</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> for each limb <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> (or 0 if
the limbs are equal). Then the quantity
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.883em;vertical-align:-0.2719em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">general</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0219em;vertical-align:-0.2719em;"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord texttt">input0</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0219em;vertical-align:-0.2719em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">input1</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> will
be 1 if and only if <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.883em;vertical-align:-0.2719em;"></span><span class="mord"><span class="mord text"><span class="mord texttt">general</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1897em;"><span style="top:-2.4281em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2719em;"><span></span></span></span></span></span></span></span></span></span> is indeed the modular
inverse, which is only possible if the difference is non-zero.</p>
</li>
<li>
<p><code>Jumps</code>: For jumps, we use the first two columns: <code>should_jump</code> and
<code>cond_sum_pinv</code>. <code>should_jump</code> conditions whether the EVM should
jump: it's 1 for a JUMP, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord texttt">condition</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> for a
JUMPI. To check if the condition is actually non-zero for a JUMPI,
<code>cond_sum_pinv</code> stores the modular inverse of <code>condition</code> (or 0 if
it's zero).</p>
</li>
<li>
<p><code>Shift</code>: For shifts, the logic differs depending on whether the
displacement is lower than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span></span></span></span>, i.e. if it fits in a single
value limb. To check if this is not the case, we must check that at
least one of the seven high limbs is not zero. The general column
<code>high_limb_sum_inv</code> holds the modular inverse of the sum of the
seven high limbs, and is used to check it's non-zero like the
previous cases. Contrary to the logic operations, we do not need to
check limbs individually: each limb has been range-checked to 32
bits, meaning that it's not possible for the sum to overflow and be
zero if some of the limbs are non-zero.</p>
</li>
<li>
<p><code>Stack</code>: <code>stack_inv</code>, <code>stack_inv_aux</code> and <code>stack_inv_aux_2</code> are used
by popping-only (resp. pushing-only) instructions to check if the
stack is empty after (resp. was empty before) the instruction.
<code>stack_len_bounds_ aux</code> is used to check that the stack doesn't
overflow in user mode. We use the last four columns to prevent
conflicts with the other general columns. See
<a href="./../cpu_execution/stack_handling.html">stack handling</a> for more details.</p>
</li>
<li>
<p><code>Push</code>: <code>is_not_kernel</code> is used to skip range-checking the output of
a PUSH operation when we are in privileged mode, as the kernel code
is known and trusted.</p>
</li>
<li>
<p><code>Context pruning</code>: When <code>SET_CONTEXT</code> is called to return to a
parent context, this makes the current context stale. The kernel
indicates it by setting one general column to 1. For more details
about context pruning, see <a href="./memory.html#context-pruning">context-pruning</a>.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tables/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../tables/arithmetic.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tables/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../tables/arithmetic.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
